on:
  push:


jobs:
  process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
          
      - name: Read markdown files
        id: read-markdown
        run: |
          content=""
          for f in adr/*.md; do
            content="$content$(cat "$f")\n"
          done
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          echo "::set-output name=content::$content"
      
      - name: OpenAI ChatGPT Action
        id: gpt-response
        uses: cahaseler/openai-api@v1.0.0
        with:
          apiKey: ${{ secrets.OPENAI_API_KEY }}
          prompt: 'Please translate the following English text to French, preserving all markdown formatting and structure exactly as it is. It is very important to send back only the markdown code as the response will be directly appended to the file:'
          input: ${{ steps.read-markdown.outputs.content }}
          model: 'gpt-4'
          temperature: 1
          max_tokens: 200

      - name : Print prompt to log
        run: |
          echo ${{ steps.read-markdown.outputs.content }}

      - name: Print Translated Content
        run: |
          echo "Translated Content: ${{ steps.gpt-response.outputs.completion }}"
  
      - name: Save Translated Content to File
        run: echo "${{ steps.gpt-response.outputs.completion }}" > adr/translated_file.md
             echo "TRANSLATED_FILE=adr/translated_file.md" >> $GITHUB_ENV


      - name: Create New Branch and Push
        run: |
          new_branch="translate-to-french-${GITHUB_SHA::8}"
          git checkout -b $new_branch
          git add ${{ env.TRANSLATED_FILE }}
          git commit -m "Translate markdown file to French"
          git push origin $new_branch
          echo "NEW_BRANCH=$new_branch" >> $GITHUB_ENV

      - name: Create Pull Request
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: ${{ env.NEW_BRANCH }}
          destination_branch: "main"  # or the branch you want to merge into
          pr_title: "Translate Markdown to French"
          pr_body: "This PR contains a translated markdown file."

      